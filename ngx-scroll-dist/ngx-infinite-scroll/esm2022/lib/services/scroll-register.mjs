import { of, fromEvent } from 'rxjs';
import { map, mergeMap, tap, throttleTime, filter } from 'rxjs/operators';
import { AxisResolver } from './axis-resolver';
import { shouldTriggerEvents } from './event-trigger';
import { resolveContainerElement } from './ngx-ins-utils';
import { calculatePoints, createResolver } from './position-resolver';
import * as ScrollResolver from './scroll-resolver';
import { ScrollState } from './scroll-state';
export function createScroller(config) {
    const { scrollContainer, scrollWindow, element, fromRoot } = config;
    const resolver = createResolver({
        axis: new AxisResolver(!config.horizontal),
        windowElement: resolveContainerElement(scrollContainer, scrollWindow, element, fromRoot),
    });
    const scrollState = new ScrollState({
        totalToScroll: calculatePoints(element, resolver),
    });
    const options = {
        container: resolver.container,
        throttle: config.throttle,
    };
    const distance = {
        up: config.upDistance,
        down: config.downDistance,
    };
    return attachScrollEvent(options).pipe(mergeMap(() => of(calculatePoints(element, resolver))), map((positionStats) => toInfiniteScrollParams(scrollState.lastScrollPosition, positionStats, distance)), tap(({ stats }) => scrollState.updateScroll(stats.scrolled, stats.totalToScroll)), filter(({ fire, scrollDown, stats: { totalToScroll } }) => shouldTriggerEvents(config.alwaysCallback, fire, scrollState.isTriggeredScroll(totalToScroll, scrollDown))), tap(({ scrollDown, stats: { totalToScroll } }) => {
        scrollState.updateTriggeredFlag(totalToScroll, scrollDown);
    }), map(toInfiniteScrollAction));
}
export function attachScrollEvent(options) {
    let obs = fromEvent(options.container, 'scroll');
    // For an unknown reason calling `sampleTime()` causes trouble for many users, even with `options.throttle = 0`.
    // Let's avoid calling the function unless needed.
    // Replacing with throttleTime seems to solve the problem
    // See https://github.com/orizens/ngx-infinite-scroll/issues/198
    if (options.throttle) {
        obs = obs.pipe(throttleTime(options.throttle, undefined, {
            leading: true,
            trailing: true,
        }));
    }
    return obs;
}
export function toInfiniteScrollParams(lastScrollPosition, stats, distance) {
    const { scrollDown, fire } = ScrollResolver.getScrollStats(lastScrollPosition, stats, distance);
    return {
        scrollDown,
        fire,
        stats,
    };
}
export const InfiniteScrollActions = {
    DOWN: '[NGX_ISE] DOWN',
    UP: '[NGX_ISE] UP',
};
export function toInfiniteScrollAction(response) {
    const { scrollDown, stats: { scrolled: currentScrollPosition }, } = response;
    return {
        type: scrollDown ? InfiniteScrollActions.DOWN : InfiniteScrollActions.UP,
        payload: {
            currentScrollPosition,
        },
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2Nyb2xsLXJlZ2lzdGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvbmd4LWluZmluaXRlLXNjcm9sbC9zcmMvbGliL3NlcnZpY2VzL3Njcm9sbC1yZWdpc3Rlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQWMsRUFBRSxFQUFFLFNBQVMsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUNqRCxPQUFPLEVBQUUsR0FBRyxFQUFFLFFBQVEsRUFBRSxHQUFHLEVBQUUsWUFBWSxFQUFFLE1BQU0sRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRzFFLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUMvQyxPQUFPLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUN0RCxPQUFPLEVBQUUsdUJBQXVCLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUMxRCxPQUFPLEVBQUUsZUFBZSxFQUFFLGNBQWMsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQ3RFLE9BQU8sS0FBSyxjQUFjLE1BQU0sbUJBQW1CLENBQUM7QUFDcEQsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRTdDLE1BQU0sVUFBVSxjQUFjLENBQUMsTUFBd0I7SUFDckQsTUFBTSxFQUFFLGVBQWUsRUFBRSxZQUFZLEVBQUUsT0FBTyxFQUFFLFFBQVEsRUFBRSxHQUFHLE1BQU0sQ0FBQztJQUNwRSxNQUFNLFFBQVEsR0FBRyxjQUFjLENBQUM7UUFDOUIsSUFBSSxFQUFFLElBQUksWUFBWSxDQUFDLENBQUMsTUFBTSxDQUFDLFVBQVUsQ0FBQztRQUMxQyxhQUFhLEVBQUUsdUJBQXVCLENBQ3BDLGVBQWUsRUFDZixZQUFZLEVBQ1osT0FBTyxFQUNQLFFBQVEsQ0FDVDtLQUNGLENBQUMsQ0FBQztJQUNILE1BQU0sV0FBVyxHQUFHLElBQUksV0FBVyxDQUFDO1FBQ2xDLGFBQWEsRUFBRSxl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Q0FBQyxDQUFDLENBQUMscUJBQXFCLENBQUMsRUFBRTtRQUN4RSxPQUFPLEVBQUU7WUFDUCxxQkFBcUI7U0FDdEI7S0FDRixDQUFDO0FBQ0osQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IE9ic2VydmFibGUsIG9mLCBmcm9tRXZlbnQgfSBmcm9tICdyeGpzJztcclxuaW1wb3J0IHsgbWFwLCBtZXJnZU1hcCwgdGFwLCB0aHJvdHRsZVRpbWUsIGZpbHRlciB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcclxuXHJcbmltcG9ydCAqIGFzIE1vZGVscyBmcm9tICcuLi8uLi9tb2RlbHMnO1xyXG5pbXBvcnQgeyBBeGlzUmVzb2x2ZXIgfSBmcm9tICcuL2F4aXMtcmVzb2x2ZXInO1xyXG5pbXBvcnQgeyBzaG91bGRUcmlnZ2VyRXZlbnRzIH0gZnJvbSAnLi9ldmVudC10cmlnZ2VyJztcclxuaW1wb3J0IHsgcmVzb2x2ZUNvbnRhaW5lckVsZW1lbnQgfSBmcm9tICcuL25neC1pbnMtdXRpbHMnO1xyXG5pbXBvcnQgeyBjYWxjdWxhdGVQb2ludHMsIGNyZWF0ZVJlc29sdmVyIH0gZnJvbSAnLi9wb3NpdGlvbi1yZXNvbHZlcic7XHJcbmltcG9ydCAqIGFzIFNjcm9sbFJlc29sdmVyIGZyb20gJy4vc2Nyb2xsLXJlc29sdmVyJztcclxuaW1wb3J0IHsgU2Nyb2xsU3RhdGUgfSBmcm9tICcuL3Njcm9sbC1zdGF0ZSc7XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gY3JlYXRlU2Nyb2xsZXIoY29uZmlnOiBNb2RlbHMuSVNjcm9sbGVyKSB7XHJcbiAgY29uc3QgeyBzY3JvbGxDb250YWluZXIsIHNjcm9sbFdpbmRvdywgZWxlbWVudCwgZnJvbVJvb3QgfSA9IGNvbmZpZztcclxuICBjb25zdCByZXNvbHZlciA9IGNyZWF0ZVJlc29sdmVyKHtcclxuICAgIGF4aXM6IG5ldyBBeGlzUmVzb2x2ZXIoIWNvbmZpZy5ob3Jpem9udGFsKSxcclxuICAgIHdpbmRvd0VsZW1lbnQ6IHJlc29sdmVDb250YWluZXJFbGVtZW50KFxyXG4gICAgICBzY3JvbGxDb250YWluZXIsXHJcbiAgICAgIHNjcm9sbFdpbmRvdyxcclxuICAgICAgZWxlbWVudCxcclxuICAgICAgZnJvbVJvb3RcclxuICAgICksXHJcbiAgfSk7XHJcbiAgY29uc3Qgc2Nyb2xsU3RhdGUgPSBuZXcgU2Nyb2xsU3RhdGUoe1xyXG4gICAgdG90YWxUb1Njcm9sbDogY2FsY3VsYXRlUG9pbnRzKGVsZW1lbnQsIHJlc29sdmVyKSxcclxuICB9KTtcclxuICBjb25zdCBvcHRpb25zOiBNb2RlbHMuSVNjcm9sbFJlZ2lzdGVyQ29uZmlnID0ge1xyXG4gICAgY29udGFpbmVyOiByZXNvbHZlci5jb250YWluZXIsXHJcbiAgICB0aHJvdHRsZTogY29uZmlnLnRocm90dGxlLFxyXG4gIH07XHJcbiAgY29uc3QgZGlzdGFuY2UgPSB7XHJcbiAgICB1cDogY29uZmlnLnVwRGlzdGFuY2UsXHJcbiAgICBkb3duOiBjb25maWcuZG93bkRpc3RhbmNlLFxyXG4gIH07XHJcbiAgcmV0dXJuIGF0dGFjaFNjcm9sbEV2ZW50KG9wdGlvbnMpLnBpcGUoXHJcbiAgICBtZXJnZU1hcCgoKSA9PiBvZihjYWxjdWxhdGVQb2ludHMoZWxlbWVudCwgcmVzb2x2ZXIpKSksXHJcbiAgICBtYXAoKHBvc2l0aW9uU3RhdHM6IE1vZGVscy5JUG9zaXRpb25TdGF0cykgPT5cclxuICAgICAgdG9JbmZpbml0ZVNjcm9sbFBhcmFtcyhcclxuICAgICAgICBzY3JvbGxTdGF0ZS5sYXN0U2Nyb2xsUG9zaXRpb24sXHJcbiAgICAgICAgcG9zaXRpb25TdGF0cyxcclxuICAgICAgICBkaXN0YW5jZVxyXG4gICAgICApXHJcbiAgICApLFxyXG4gICAgdGFwKCh7IHN0YXRzIH06IE1vZGVscy5JU2Nyb2xsUGFyYW1zKSA9PlxyXG4gICAgICBzY3JvbGxTdGF0ZS51cGRhdGVTY3JvbGwoc3RhdHMuc2Nyb2xsZWQsIHN0YXRzLnRvdGFsVG9TY3JvbGwpXHJcbiAgICApLFxyXG4gICAgZmlsdGVyKFxyXG4gICAgICAoeyBmaXJlLCBzY3JvbGxEb3duLCBzdGF0czogeyB0b3RhbFRvU2Nyb2xsIH0gfTogTW9kZWxzLklTY3JvbGxQYXJhbXMpID0+XHJcbiAgICAgICAgc2hvdWxkVHJpZ2dlckV2ZW50cyhcclxuICAgICAgICAgIGNvbmZpZy5hbHdheXNDYWxsYmFjayxcclxuICAgICAgICAgIGZpcmUsXHJcbiAgICAgICAgICBzY3JvbGxTdGF0ZS5pc1RyaWdnZXJlZFNjcm9sbCh0b3RhbFRvU2Nyb2xsLCBzY3JvbGxEb3duKVxyXG4gICAgICAgIClcclxuICAgICksXHJcbiAgICB0YXAoKHsgc2Nyb2xsRG93biwgc3RhdHM6IHsgdG90YWxUb1Njcm9sbCB9IH06IE1vZGVscy5JU2Nyb2xsUGFyYW1zKSA9PiB7XHJcbiAgICAgIHNjcm9sbFN0YXRlLnVwZGF0ZVRyaWdnZXJlZEZsYWcodG90YWxUb1Njcm9sbCwgc2Nyb2xsRG93bik7XHJcbiAgICB9KSxcclxuICAgIG1hcCh0b0luZmluaXRlU2Nyb2xsQWN0aW9uKVxyXG4gICk7XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBhdHRhY2hTY3JvbGxFdmVudChcclxuICBvcHRpb25zOiBNb2RlbHMuSVNjcm9sbFJlZ2lzdGVyQ29uZmlnXHJcbik6IE9ic2VydmFibGU8e30+IHtcclxuICBsZXQgb2JzID0gZnJvbUV2ZW50KG9wdGlvbnMuY29udGFpbmVyLCAnc2Nyb2xsJyk7XHJcbiAgLy8gRm9yIGFuIHVua25vd24gcmVhc29uIGNhbGxpbmcgYHNhbXBsZVRpbWUoKWAgY2F1c2VzIHRyb3VibGUgZm9yIG1hbnkgdXNlcnMsIGV2ZW4gd2l0aCBgb3B0aW9ucy50aHJvdHRsZSA9IDBgLlxyXG4gIC8vIExldCdzIGF2b2lkIGNhbGxpbmcgdGhlIGZ1bmN0aW9uIHVubGVzcyBuZWVkZWQuXHJcbiAgLy8gUmVwbGFjaW5nIHdpdGggdGhyb3R0bGVUaW1lIHNlZW1zIHRvIHNvbHZlIHRoZSBwcm9ibGVtXHJcbiAgLy8gU2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9vcml6ZW5zL25neC1pbmZpbml0ZS1zY3JvbGwvaXNzdWVzLzE5OFxyXG4gIGlmIChvcHRpb25zLnRocm90dGxlKSB7XHJcbiAgICBvYnMgPSBvYnMucGlwZShcclxuICAgICAgdGhyb3R0bGVUaW1lKG9wdGlvbnMudGhyb3R0bGUsIHVuZGVmaW5lZCwge1xyXG4gICAgICAgIGxlYWRpbmc6IHRydWUsXHJcbiAgICAgICAgdHJhaWxpbmc6IHRydWUsXHJcbiAgICAgIH0pXHJcbiAgICApO1xyXG4gIH1cclxuICByZXR1cm4gb2JzIGFzIGFueTtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIHRvSW5maW5pdGVTY3JvbGxQYXJhbXMoXHJcbiAgbGFzdFNjcm9sbFBvc2l0aW9uOiBudW1iZXIsXHJcbiAgc3RhdHM6IE1vZGVscy5JUG9zaXRpb25TdGF0cyxcclxuICBkaXN0YW5jZTogTW9kZWxzLklTY3JvbGxlckRpc3RhbmNlXHJcbik6IE1vZGVscy5JU2Nyb2xsUGFyYW1zIHtcclxuICBjb25zdCB7IHNjcm9sbERvd24sIGZpcmUgfSA9IFNjcm9sbFJlc29sdmVyLmdldFNjcm9sbFN0YXRzKFxyXG4gICAgbGFzdFNjcm9sbFBvc2l0aW9uLFxyXG4gICAgc3RhdHMsXHJcbiAgICBkaXN0YW5jZVxyXG4gICk7XHJcbiAgcmV0dXJuIHtcclxuICAgIHNjcm9sbERvd24sXHJcbiAgICBmaXJlLFxyXG4gICAgc3RhdHMsXHJcbiAgfTtcclxufVxyXG5cclxuZXhwb3J0IGNvbnN0IEluZmluaXRlU2Nyb2xsQWN0aW9ucyA9IHtcclxuICBET1dOOiAnW05HWF9JU0VdIERPV04nLFxyXG4gIFVQOiAnW05HWF9JU0VdIFVQJyxcclxufTtcclxuXHJcbmV4cG9ydCBmdW5jdGlvbiB0b0luZmluaXRlU2Nyb2xsQWN0aW9uKFxyXG4gIHJlc3BvbnNlOiBNb2RlbHMuSVNjcm9sbFBhcmFtc1xyXG4pOiBNb2RlbHMuSUluZmluaXRlU2Nyb2xsQWN0aW9uIHtcclxuICBjb25zdCB7XHJcbiAgICBzY3JvbGxEb3duLFxyXG4gICAgc3RhdHM6IHsgc2Nyb2xsZWQ6IGN1cnJlbnRTY3JvbGxQb3NpdGlvbiB9LFxyXG4gIH0gPSByZXNwb25zZTtcclxuICByZXR1cm4ge1xyXG4gICAgdHlwZTogc2Nyb2xsRG93biA/IEluZmluaXRlU2Nyb2xsQWN0aW9ucy5ET1dOIDogSW5maW5pdGVTY3JvbGxBY3Rpb25zLlVQLFxyXG4gICAgcGF5bG9hZDoge1xyXG4gICAgICBjdXJyZW50U2Nyb2xsUG9zaXRpb24sXHJcbiAgICB9LFxyXG4gIH07XHJcbn1cclxuIl19